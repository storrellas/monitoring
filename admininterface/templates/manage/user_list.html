{% extends 'base.html' %}

{% load staticfiles %}
{% load tags %}

{% block contents %}

<script type="text/javascript">
$('document').ready(function(){
	var $result = $("#INSERTRESULT").val();
	if($result == "SUCCESS")
	{
		alert("SUCCESS!");
 	 	location.href = location.href;
	}
});
</script>


<div class="wrapper wrapper-content">
	<div class="row">
		<div class="col-lg-12">
			<div class="ibox float-e-margins">
				<div class="ibox-title">
					<div class="row">
						<div class="col-lg-12">
							<h5 style="margin-top: 6px">
								Total Users:
								{{ event_user_list|length }}
							</h5>
							<a data-toggle="modal" class="btn btn-primary"
								style="float: right; margin-right: 10px" href="#modal-form-new"
								{% if notrequest.user.is_superuser %}
								disabled
								{% endif %}
										>Add
								User</a>
						</div>
					</div>
				</div>
				<div class="ibox-content">
					<!-- modal form 'edit Password' -->
					<div id="modal-form-editpass" class="modal fade" aria-hidden="true">
						<div class="modal-smalldialog">
							<div class="modal-content">
								<div class="modal-body">
									<div class="row">
										<div class="col-sm-12">
											<h3 class="m-t-none m-b">Change Password</h3>
											<form role="form" id="updatePasswordForm">
												<input type="hidden" id="upuserid" value="">
												<input type="hidden" id="upusername" value="">
												<input type="hidden" id="updescription" value="">
												<div class="form-group">
													<label>Password*</label> <input type="password"
														placeholder="Password" class="form-control required"
														name="uppassword" id="uppassword">
												</div>
												<div class="form-group">
													<label>Confirm*</label> <input type="password"
														placeholder="Confirm password"
														class="form-control required" name="upconfirmpass"
														id="upconfirmpass">
												</div>
												<div>
													<button class="btn btn-sm btn-primary pull-right m-t-n-xs"
														type="submit" onclick="on_editpass_done()">
														<strong>Change</strong>
													</button>
													<button class="btn btn-sm btn-primary pull-right m-t-n-xs"
														style="margin-right: 20px;" type="button"
														onclick="on_cancel_editpass()">
														<strong>Cancel</strong>
													</button>
												</div>
											</form>
										</div>

									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- modal form 'new' -->
					<div id="modal-form-new" class="modal fade" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-body">
									<div class="row">
										<div class="col-sm-12">
											<h3 class="m-t-none m-b">Create User</h3>
											<form role="form" id="createNewUser">
												<div class="form-group">
													<label><b class="required">*</b>Username:</label> <input
														type="text" placeholder="" class="form-control required"
														name="username" id="username">
												</div>
												<div class="form-group">
													<label><b class="required">*</b>Password:</label> <input
														type="password" placeholder=""
														class="form-control required" name="cpassword_edit"
														id="cpassword_edit">
												</div>
												<div class="form-group">
													<label><b class="required">*</b>Confirm Password:</label> <input
														type="password" placeholder=""
														class="form-control required" name="ccpassword_edit"
														id="ccpassword_edit">
												</div>
												<div class="form-group">
													<label>Description:</label>
													<textarea class="form-control" name="description"
														id="description" style="width: 100%; height: 100px;"></textarea>
												</div>
												<div>
													<button class="btn btn-sm btn-primary pull-right m-t-n-xs"
														type="submit" onclick="on_create()">
														<strong>Create</strong>
													</button>
													<button class="btn btn-sm btn-primary pull-right m-t-n-xs"
														style="margin-right: 20px;" type="button"
														onclick="on_cancel_new()">
														<strong>Cancel</strong>
													</button>
												</div>
											</form>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- modal form 'Edit' -->
					<div id="modal-form-edit" class="modal fade" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-body">
									<div class="row">
										<div class="col-sm-12">
											<h3 class="m-t-none m-b">Edit User</h3>
											<form role="form" id="editUser" method="post"
												enctype="multipart/form-data">
												<div class="form-group">
													<label><b class="required">*</b>Username:</label> <input
														type="text" placeholder="" class="form-control required"
														name="eusername" id="eusername">
												</div>
												<div class="form-group">
													<label>Description:</label>
													<textarea class="form-control" name="edescription"
														id="edescription" style="width: 100%; height: 100px;"></textarea>
												</div>
												<div>
													<button class="btn btn-sm btn-primary pull-right m-t-n-xs"
														type="submit" onclick="on_edit_done()">
														<strong>Save</strong>
													</button>
													<button class="btn btn-sm btn-primary pull-right m-t-n-xs"
														style="margin-right: 20px;" type="button"
														onclick="on_cancel_edit()">
														<strong>Cancel</strong>
													</button>
												</div>
											</form>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<form class="form-horizontal searchformUserList" action="" method="get">
						<div>
							<div class="col-md-6">
								<label class="control-label">Search:</label>
								<input type="search" class="form-control" name="search_data"
													id="search_data" placeholder="Search Username"
													value="{{ search_data }}">
							</div>
							<div class="col-md-3">
								<label class="control-label">Sort:</label>
								<select class="form-control m-b" name="order_field"
									id="order_field">											
									<option value="ASC" {% ifequal sortMode 'ASC'%}selected{% endifequal %} >ASC</option>
									<option value="DESC"{% ifequal sortMode 'DESC'%}selected{% endifequal %}>DESC</option>
								</select>
							</div>
							<div class="col-md-3">
								<button class="btn btn-primary" type="submit">Go!</button>
							</div>
						</div>
					</form>
					<div class="row">
					</div>

					<!-- confirm modal form -->
					<div id="modal-confirm" class="modal fade" aria-hidden="true"
						aria-labelledby="confirm-modal-label">
						<div class="modal-dialog">
							<div class="modal-content">
								<input type="hidden" id="modal-opener" value=""> <input
									type="hidden" id="modal-return" value=""> <input
									type="hidden" id="modal-callback" value=""> <input
									type="hidden" id="modal-param" value="">

								<div class="modal-header">
									<h4 class="modal-title" id="confirm-modal-label">Confirm
										dialog</h4>
								</div>

								<div class="modal-body">
									<p id="modal-message"></p>
								</div>

								<div class="modal-footer" style="padding: 10px 20px 5px">
									<button class="btn btn-sm btn-primary pull-right"
										data-dismiss="modal">Cancel</button>
									<button class="btn btn-sm btn-primary pull-right"
										style="margin-right: 10px;" onclick="on_ok_confirm()">Ok</button>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-lg-12">
							<table class="tabledata" style=""id="users_table">
								<tbody id="users_body">
									<tr>
										<th>No</th>
										<th class="textleft">Usernames</th>
										<th class="textleft">Description</th>
										<th class="textright">Actions</th>
									</tr>
									{% for user in event_user_list %}
									<tr>
										<td  class="textleft">
											{{ user.id }}
										</td>
										<td  class="textleft">
											{{ user.username }}
										</td>
										<td  class="textleft">
											{{ user.eventuser.description }}
										</td>
										<td class="actions">
											<a class="btn btn-sm btn-white btn-action"
											onclick="on_editpass('{{ user.id }}','{{user.username}}','{{ user.first_name }}');"
											data-toggle="tooltip" data-placement="bottom"
											title="Change Password"
											{% if not request.user.is_superuser %}
											disabled
											{% endif %}> 
											<img src="{% static 'inspinia_admin/img/icon/change_password.png' %}">
										</a> 
										<a class="btn btn-sm btn-white btn-action"
											onclick="on_edit('{{ user.id }}');"
											data-toggle="tooltip" data-placement="bottom" title="Edit"
											{% if not request.user.is_superuser %}
											disabled
											{% endif %}
											> 
											<img src="{% static 'inspinia_admin/img/icon/change-account.png' %}">
										</a> 
										<a class="btn btn-sm btn-white btn-action"
											onclick="on_delete('{{ user.id }}');"
											data-toggle="tooltip" data-placement="bottom" title="Delete"
											{% if not request.user.is_superuser %}
											disabled
											{% endif %}
											> 
											<img src="{% static 'inspinia_admin/img/icon/delete.png' %}">
										</a>
										</td>
									</tr>
								{% empty %}
									<tr>
										<td colspan="5" class="nodatarow">
											No data
										</td>
									</tr>
								{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
					<div class="table-responsive tooltip-demo"
						style="display: block; overflow-x: auto;">
						
					</div>

					{% include 'manage/pagination.html' %}

				</div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
	function on_create()
	{
		$('#createNewUser').validate({
	        errorPlacement: function (error, element) {
	            element.before(error);
	        },
	        rules: {
	            username: {
	            	required: true
	            },
	            cpassword_edit: {
	            	required: true
	            },
	            
	            ccpassword_edit: {
	            	equalTo: "#cpassword_edit"
	            }
	        },
	        submitHandler: function(){
	        	var postData = {
	        		    username: $('#createNewUser #username').val(),
	        		    password: $('#createNewUser #cpassword_edit').val(),
	        		    description :$('#createNewUser #description').val()
	        		}
        		$.ajax({
        		  async: true,
        		  url: "{% url 'ajax-event-user'%}",
        		  dataType: "json",
        		  type: "POST",
        		  data : postData,
        		  datatype : "application/json",
        		  success: function(json) {
        		    location.reload()
        		    return;
        		  },
        		  error: function(xhr, errStr) {
        		    alert(errStr);
        		  }
        		});	        	
	        }
	    });
	}
	function on_cancel_new()
    {
        $('#modal-form-new').modal('hide');
    }
	function on_editpass(userid, username, description)
	{				
		$("#upuserid").val(userid);
		$("#upusername").val(username);
		$("#updescription").val(description);
		$("#upconfirmpass").val('');
		$("#uppassword").val('');
		$('#modal-form-editpass').modal('show');
	}
	function on_editpass_done()
	{
	    $('#updatePasswordForm').validate({
	        errorPlacement: function (error, element) {
	            element.before(error);
	        },
	        rules: {
	        	uppassword: {
	            	required: true
	            },
	            upconfirmpass: {
	            	equalTo: "#uppassword"
	            },
	        },
	
	        submitHandler: function() {
                $.ajax({
                    async: true,
                    url: "{% url 'ajax-event-user'%}" + $("#upuserid").val() + "/",
                    dataType: "json",
                    type: "PUT",
                    data: {
                        username:   $("#upusername").val(),
                        password:   $("#uppassword").val(),
                        description: $("#updescription").val(),
                    },
                    success: function(json) {
                    	location.reload()
                    	return;
                    },
                    error: function(xhr, errStr) {
                        alert(errStr);
                    }
                });
	        	
	        }
	    });
	}
	
	function on_cancel_editpass()
	{
	    $('#modal-form-editpass').modal('hide');
	}
	function on_edit(userid)
	{
		var $username	= $('#username'+userid).val();
		var $description 	= $('#description'+userid).val();
		$("#euserid").val(userid);
		$("#eusername").val($username);
		$("#edescription").val($description);
        $('#modal-form-edit').modal('show');
	}
	
	function on_edit_done()
	{
	    $('#editUser').validate({
	        errorPlacement: function (error, element) {
	            element.before(error);
	        },
	        rules: {
	            eusername: {
	            	required: true
	            },
	        },
	
	        submitHandler: function() {		        	
                $.ajax({
                    async: true,
                    url: "{% url 'ajax-event-user' %}" + $("#euserid").val() + "/",
                    dataType: "json",
                    type: "PUT",
                    data: {
                        username:   $("#eusername").val(),
                        description: $("#edescription").val(),
                    },
                    success: function(json) {
                    	location.reload()
                    	return;
                    },
                    error: function(xhr, errStr) {
                        alert(errStr);
                    }
                });
	        }
	    });
	}
	
	function on_cancel_edit()
	{
	    $('#modal-form-edit').modal('hide');
	}
    function on_delete($userid)
    {
    	if(confirm("Do you want to delete?"))
        {
    		var url_delete = "{% url 'ajax-event-user' %}" + $userid 
        	$.ajax({
                async: true,
				url: url_delete,
                dataType: "json",
                type: "DELETE",
                data: {
                    mode: "DELETE_USER",
                    userid: $userid,
                },
                success: function(json) {
                    location.reload()
                    return
                },
                error: function(xhr, errStr) {
                 	console.log(errStr);
                }
            });
        }
    }
</script>


{% endblock %}